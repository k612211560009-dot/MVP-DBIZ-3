import { useEffect } from "react";

const DifyChatbot = () => {
  useEffect(() => {
    console.log("ü§ñ [DifyChatbot] Component mounted, initializing...");

    // 1. C·∫•u h√¨nh Dify Chatbot v·ªõi ƒë·∫ßy ƒë·ªß options
    window.difyChatbotConfig = {
      token: "BcbkAB1w3sTe0mYU",
      inputs: {
        // Define inputs from Start node here if needed
      },
      systemVariables: {
        // user_id: 'USER_ID_HERE',
        // conversation_id: 'CONVERSATION_UUID_HERE',
      },
      userVariables: {
        // avatar_url: 'USER_AVATAR_URL',
        // name: 'USER_NAME',
      },
    };
    console.log("‚úÖ [DifyChatbot] Config set:", window.difyChatbotConfig);

    // 2. Th√™m custom CSS styling cho chatbot
    const style = document.createElement("style");
    style.textContent = `
      #dify-chatbot-bubble-button {
        background-color: #ec4899 !important;
      }
      #dify-chatbot-bubble-window {
        width: 24rem !important;
        height: 40rem !important;
      }
    `;
    document.head.appendChild(style);

    // 3. T·∫°o th·∫ª script ƒë·ªÉ t·∫£i file embed.min.js
    const script = document.createElement("script");
    script.src = "https://udify.app/embed.min.js";
    script.id = "BcbkAB1w3sTe0mYU";
    script.defer = true;

    script.onload = () => {
      console.log("‚úÖ [DifyChatbot] Script loaded successfully!");
      console.log("üîç [DifyChatbot] Checking window.dify object:", window.dify);
      console.log(
        "üîç [DifyChatbot] All window keys with 'dify':",
        Object.keys(window).filter((k) => k.toLowerCase().includes("dify"))
      );

      // Check DOM elements at different intervals
      [1000, 3000, 5000].forEach((delay) => {
        setTimeout(() => {
          const bubble = document.querySelector("#dify-chatbot-bubble-button");
          const iframe = document.querySelector('iframe[id^="dify-chatbot"]');
          const allIframes = document.querySelectorAll("iframe");
          const allScripts = document.querySelectorAll(
            'script[src*="dify"], script[src*="udify"]'
          );

          console.log(`üîç [DifyChatbot] Check after ${delay}ms:`, {
            bubbleFound: !!bubble,
            iframeFound: !!iframe,
            totalIframes: allIframes.length,
            iframeList: Array.from(allIframes).map((f) => f.src || f.id),
            totalDifyScripts: allScripts.length,
            scriptList: Array.from(allScripts).map((s) => s.src),
          });

          if (bubble) {
            console.log("‚úÖ [DifyChatbot] Chatbot is visible!");
          } else if (delay === 5000) {
            console.error(
              "‚ùå [DifyChatbot] Chatbot button still not found after 5s"
            );
            console.error("üí° Possible issues:");
            console.error(
              "  1. Token 'BcbkAB1w3sTe0mYU' may be invalid or expired"
            );
            console.error("  2. Dify service may be down");
            console.error("  3. Network may be blocking udify.app");
            console.error(
              "üîç Check Network tab in DevTools for failed requests"
            );
          }
        }, delay);
      });
    };

    script.onerror = (error) => {
      console.error("‚ùå [DifyChatbot] Failed to load script:", error);
    };

    document.body.appendChild(script);
    console.log("üìå [DifyChatbot] Script tag added to body");

    // 4. Cleanup: X√≥a script v√† style khi component b·ªã unmount
    return () => {
      console.log("üßπ [DifyChatbot] Cleaning up...");
      const existingScript = document.getElementById("BcbkAB1w3sTe0mYU");
      if (existingScript) {
        document.body.removeChild(existingScript);
      }
      if (style.parentNode) {
        document.head.removeChild(style);
      }
      delete window.difyChatbotConfig;
    };
  }, []);

  console.log("üé® [DifyChatbot] Rendering component");
  return null; // Component n√†y kh√¥ng c·∫ßn render giao di·ªán v√¨ script t·ª± t·∫°o bong b√≥ng chat
};

export default DifyChatbot;
